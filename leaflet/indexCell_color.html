<html lang="en-US" xmlns="http://www.w3.org/1999/xhtml">
   <head profile="http://gmpg.org/xfn/11">
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
 
      <link rel="stylesheet" type="text/css" href="library/leaflet/leaflet.css" />
      
      <script type='text/javascript' src='https://code.jquery.com/jquery-3.3.1.min.js'></script>
      <script type='text/javascript' src='library/leaflet/leaflet.js'></script>
	   <script type='text/javascript' src='library/turfjs/turf.min.js'></script>
	   <style>
		.custom-icon {
		  width: 3rem;
		  height: 3rem;
		  display: block;
		  position: relative;
		  border-radius: 3rem 3rem 0;
		  transform: rotate(45deg);
		  border: 1px solid #FFFFFF
		}
	   </style>
   </head>
 
   <body>
		<h1>Leaflet Example</h1> 
		<!-- <p>Here's a map of the countries I've either lived in or travelled through for a month or more. -->
		<div id="map" style="float: left; height: 600px; width: 1200px; border: 1px solid #AAA;"></div>
		<div id="note" style="float: left; padding-left: 50px;"></div>
		
		
		<script>
		var map = L.map('map').setView([48.174665, -2.010904], 10);

		//L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
		//	attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			//}).addTo(map);
		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			}).addTo(map);
			
		var cellJsonList = [];
		var skip = 0;
		var take = 1;
		var point = {
				"type": "FeatureCollection",
				"properties":"",
				"features" : []
			}
		var markerGroup = L.layerGroup();
		

		const icon = L.divIcon({
		  className: 'leaflet-div-icon custom-icon',
		  iconAnchor: [0, 24],
		  labelAnchor: [-6, 0],
		  popupAnchor: [0, -36],
		 // html: `<span style="${markerHtmlStyles}" />`
		})
		
		L.marker([48.174665, -2.010904], {icon: icon}).addTo(map);
		
		
		
		$(document).ready(function(){
			
			$.getJSON("CellInformation_phone_2.json", function(jsonList) {
				$("#note").append("<p>Cell list count: " + jsonList.length +"</p>")
				cellJsonList = jsonList;	
				drawCell();
			});
			
			map.on('dblclick',function(e){
				map.removeLayer(markerGroup)
				
					drawCell();
					console.log('dblclick event');
					
			})
		});
	
		function drawCell(){
			
				var list = cellJsonList.skiptake();
				var pointinside=[];
				var pointborder=[];
				markerGroup.clearLayers();				
				$("#note").append("<p>" + skip + " Cells were drawn</p>");
				map.removeLayer(markerGroup)
				var cellGeoList = [];
				list.forEach(function(item){
					cellGeoList.push(createFeatureCollection(item))
					points=createpolygon(item)
					pointinside.push(points[0])
					pointborder.push(points[1])
				})
				pointinside.forEach(function(item){	
					item.features.forEach(function (fea){
					L.marker([fea.geometry.coordinates[1],fea.geometry.coordinates[0]]).addTo(markerGroup)
					})	
				})
				pointborder.forEach(function(item){
				
					L.geoJSON([item,turf.concave(item)],{style: style}).addTo(map).bindPopup(item.properties).openPopup();

				})
				markerGroup.addTo(map)
		}
		
		
		
		function style() {
			rand=Math.random()
			return {
			weight: 2,
			opacity: 1,
			color: '#'+(0x1000000+(rand)*0xffffff).toString(16).substr(1,6),
			dashArray: '5',
			fillOpacity: 0.6,
			fillColor: '#'+(0x1000000+(rand)*0xffffff).toString(16).substr(1,6)
			};
		}
		
		function createpolygon(cellGeo){
			var Border=[]; 
			var Inside=[];
			
			cellGeo.features.forEach(function(item){
				if (item.prop == "border"){
					Border.push(createFeature(item.lat,item.lon,item.prop))}
				else {Inside.push(createFeature(item.lat,item.lon,item.prop))}
				
			})
			pointInside=Object.create(point)
			pointBorder=Object.create(point)
			pointBorder.properties=cellGeo.property
			pointInside.properties=cellGeo.property
			pointBorder.features=Border
			pointInside.features=Inside
			
			return [pointInside,pointBorder]
		}
		
	
		Array.prototype.skiptake = function () {
			if (skip >= this.length) return [];
			
			take = this.length > (skip + take) ? take : (this.length - skip);
			
			var result = this.slice(skip, skip + take);
			skip += take;
			
			return result;		
		}
		
		function createFeatureCollection (cellGeo){
			var features = [];
			cellGeo.features.forEach(function(item){
				features.push(createFeature(item.lat,item.lon))
			})
			poin=Object.create(point)
			poin.properties=cellGeo.property
			poin.features=features
			return poin
		}
		
		function createFeature(lat,lon,prop){
			var feature={
					  "type": "Feature",
					  
					  "geometry": {
						"type": "Point",
						"coordinates": [parseFloat(lon),parseFloat(lat)]
					  }
					}
			
			return feature
		}
		
		</script>
    
   </body>
</html>