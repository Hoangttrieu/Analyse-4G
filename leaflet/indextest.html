<html lang="en-US" xmlns="http://www.w3.org/1999/xhtml">
   <head profile="http://gmpg.org/xfn/11">
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
 
      <link rel="stylesheet" type="text/css" href="library/leaflet/leaflet.css" />
      
      <script type='text/javascript' src='https://code.jquery.com/jquery-3.3.1.min.js'></script>
      <script type='text/javascript' src='library/leaflet/leaflet.js'></script>
	   <script type='text/javascript' src='library/leaflet/HeatLayer.js'></script>
	   	   <script type='text/javascript' src='library/leaflet/leaflet-heat.js'></script>
	   <script type='text/javascript' src='library/turfjs/turf.min.js'></script>
	  
   </head>
 
   <body>
		<h1>Cellulars in Rennes</h1> 
		<!-- <p>Here's a map of the cellulars in Bretagne. -->
		<div id="map" style="float: left; height: 600px; width: 1200px; border: 1px solid #AAA;"></div>
		<div id="note" style="float: left; padding-left: 50px;"></div>
		
		
		<script>
		

		//L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
		//	attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			//}).addTo(map);
		var baselayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			});//.addTo(map);
		var heatpoints=[]
		var heatmap = L.heatLayer(heatpoints,{config});
		var map = L.map('map',{center:[48.174665, -2.010904],zoom:15,layers:[baselayer,heatmap]});
		var cellJsonList = [];
		var skip = 0;
		var take = 1;
		var point = {
				"type": "FeatureCollection",
				"properties":"",
				"features" : []
			}
		var markerGroup = L.layerGroup();
		var polygons = L.layerGroup();
		
		var basemap={"baselayer":baselayer}
		var heatmaps={"Heatmap":heatmap}

		
		L.control.layers(basemap,heatmaps).addTo(map);
		$(document).ready(function(){
			
			$.getJSON("jsontest.json", function(jsonList) {
				$("#note").append("<p>Cell list count: " + jsonList.length +"</p>")
				cellJsonList = jsonList;	
				jsonList.forEach(function(cell){
					heatpoints = heatpoints.concat(Heatpoints(cell));
				})
				//var heatmap = L.heatLayer(heatpoints, {config}).addTo(map)
				//heatmap.addLatLng(heatpoints)
				heatpoints.forEach(function(point){
					heatmap.addLatLng(point)
				})
				//drawCell();
			});
			
			map.on('dblclick',function(e){
				map.removeLayer(markerGroup)
				
					//drawCell();
					console.log('dblclick event');
					//console.log(polygons)
			})
			
		});
	
		function drawCell(){
			
				var list = cellJsonList.skiptake();
				var pointinside=[];
				var pointborder=[];
				markerGroup.clearLayers();				
				$("#note").append("<p>" + skip + " Cells were drawn</p>");
				map.removeLayer(markerGroup)
			//	var cellGeoList = [];
				list.forEach(function(item){
				//	cellGeoList.push(createFeatureCollection(item))
					points=createpolygon(item)
					pointinside.push(points[0])
					pointborder.push(points[1])
				})
				pointinside.forEach(function(item){	
					item.features.forEach(function (fea){
					L.marker([fea.geometry.coordinates[1],fea.geometry.coordinates[0]]).addTo(markerGroup)
					})	
				})
				pointborder.forEach(function(item){
				
				    var geoJsonLayer = L.geoJSON([item,turf.convex(item)],{style: style(0.6)});
					geoJsonLayer.on('mouseover', function(e){
						e.target.setStyle({fillOpacity:1});	
					})
					geoJsonLayer.addTo(polygons).bindPopup(item.properties);
					geoJsonLayer.on('mouseout', function(e){
						e.target.setStyle({fillOpacity:0.6});
					})
				})
				
				polygons.addTo(map);
				markerGroup.addTo(map)
				
				
		}
		
		
		
		function style(opacity) {
			rand = Math.random()
			return {
				weight: 2,
				opacity: 1,
				color: '#'+(0x1000000+(rand)*0xffffff).toString(16).substr(1,6),
				dashArray: '5',
				fillOpacity: opacity,
				fillColor: '#'+(0x1000000+(rand)*0xffffff).toString(16).substr(1,6)
			};
		}
		
		function createpolygon(cellGeo){
			var Border=[]; 
			var Inside=[];
			
			cellGeo.features.forEach(function(item){
				if (item.prop == "border"){
					Border.push(createFeature(item.lat,item.lon,item.prop))}
				else {Inside.push(createFeature(item.lat,item.lon,item.prop))}
				
			})
			pointInside=Object.create(point)
			pointBorder=Object.create(point)
			pointBorder.properties=cellGeo.property
			pointInside.properties=cellGeo.property
			pointBorder.features=Border
			pointInside.features=Inside
			
			return [pointInside,pointBorder]
		}
		
	
		Array.prototype.skiptake = function () {
			if (skip >= this.length) return [];
			
			take = this.length > (skip + take) ? take : (this.length - skip);
			
			var result = this.slice(skip, skip + take);
			skip += take;
			
			return result;		
		}
		
		function createFeatureCollection (cellGeo){
			var features = [];
			cellGeo.features.forEach(function(item){
				features.push(createFeature(item.lat,item.lon))
			})
			poin=Object.create(point)
			poin.properties=cellGeo.property
			poin.features=features
			return poin
		}
		
		function createFeature(lat,lon,prop){
			var feature={
					  "type": "Feature",
					  
					  "geometry": {
						"type": "Point",
						"coordinates": [parseFloat(lon),parseFloat(lat)]
					  }
					}
			
			return feature
		}
		function Heatpoints(jsoncell){
			var point=[];
			jsoncell.features.forEach(function(item){
				if (item.RSRP!=100){
				point.push({"lat":item.lat,"lng":item.lon,"count":item.RSRP});
				}
			})
			return point
		}
		//Heatmap configuration
		var config = {
		  "radius": 0.51,
		  "minOpacity": 0.1, 
		 // "max":_.maxBy(heatpoints, function(latLngDensity) { return latLngDensity[2]; })[2],
		  "max" :97,
		  "gradient": {
			0.4:  'blue',//'#f23e45',
			0.50: 'lime',
			0.70: 'yellow',
			0.95: 'orange',//'#FF8300',
			1.0:  'red'
		  }
		};
		</script>
    
   </body>
</html>